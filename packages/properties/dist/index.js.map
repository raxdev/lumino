{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["// Copyright (c) Jupyter Development Team.\r\n// Distributed under the terms of the Modified BSD License.\r\n/*-----------------------------------------------------------------------------\r\n| Copyright (c) 2014-2017, PhosphorJS Contributors\r\n|\r\n| Distributed under the terms of the BSD 3-Clause License.\r\n|\r\n| The full license is in the file LICENSE, distributed with this software.\r\n|----------------------------------------------------------------------------*/\r\n\r\n\r\n/**\r\n * A class which attaches a value to an external object.\r\n *\r\n * #### Notes\r\n * Attached properties are used to extend the state of an object with\r\n * semantic data from an unrelated class. They also encapsulate value\r\n * creation, coercion, and notification.\r\n *\r\n * Because attached property values are stored in a hash table, which\r\n * in turn is stored in a WeakMap keyed on the owner object, there is\r\n * non-trivial storage overhead involved in their use. The pattern is\r\n * therefore best used for the storage of rare data.\r\n */\r\nexport\r\nclass AttachedProperty<T, U> {\r\n  /**\r\n   * Construct a new attached property.\r\n   *\r\n   * @param options - The options for initializing the property.\r\n   */\r\n  constructor(options: AttachedProperty.IOptions<T, U>) {\r\n    this.name = options.name;\r\n    this._create = options.create;\r\n    this._coerce = options.coerce || null;\r\n    this._compare = options.compare || null;\r\n    this._changed = options.changed || null;\r\n  }\r\n\r\n  /**\r\n   * The human readable name for the property.\r\n   */\r\n  readonly name: string;\r\n\r\n  /**\r\n   * Get the current value of the property for a given owner.\r\n   *\r\n   * @param owner - The property owner of interest.\r\n   *\r\n   * @returns The current value of the property.\r\n   *\r\n   * #### Notes\r\n   * If the value has not yet been set, the default value will be\r\n   * computed and assigned as the current value of the property.\r\n   */\r\n  get(owner: T): U {\r\n    let value: U;\r\n    let map = Private.ensureMap(owner);\r\n    if (this._pid in map) {\r\n      value = map[this._pid];\r\n    } else {\r\n      value = map[this._pid] = this._createValue(owner);\r\n    }\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * Set the current value of the property for a given owner.\r\n   *\r\n   * @param owner - The property owner of interest.\r\n   *\r\n   * @param value - The value for the property.\r\n   *\r\n   * #### Notes\r\n   * If the value has not yet been set, the default value will be\r\n   * computed and used as the previous value for the comparison.\r\n   */\r\n  set(owner: T, value: U): void {\r\n    let oldValue: U;\r\n    let map = Private.ensureMap(owner);\r\n    if (this._pid in map) {\r\n      oldValue = map[this._pid];\r\n    } else {\r\n      oldValue = map[this._pid] = this._createValue(owner);\r\n    }\r\n    let newValue = this._coerceValue(owner, value);\r\n    this._maybeNotify(owner, oldValue, map[this._pid] = newValue);\r\n  }\r\n\r\n  /**\r\n   * Explicitly coerce the current property value for a given owner.\r\n   *\r\n   * @param owner - The property owner of interest.\r\n   *\r\n   * #### Notes\r\n   * If the value has not yet been set, the default value will be\r\n   * computed and used as the previous value for the comparison.\r\n   */\r\n  coerce(owner: T): void {\r\n    let oldValue: U;\r\n    let map = Private.ensureMap(owner);\r\n    if (this._pid in map) {\r\n      oldValue = map[this._pid];\r\n    } else {\r\n      oldValue = map[this._pid] = this._createValue(owner);\r\n    }\r\n    let newValue = this._coerceValue(owner, oldValue);\r\n    this._maybeNotify(owner, oldValue, map[this._pid] = newValue);\r\n  }\r\n\r\n  /**\r\n   * Get or create the default value for the given owner.\r\n   */\r\n  private _createValue(owner: T): U {\r\n    let create = this._create;\r\n    return create(owner);\r\n  }\r\n\r\n  /**\r\n   * Coerce the value for the given owner.\r\n   */\r\n  private _coerceValue(owner: T, value: U): U {\r\n    let coerce = this._coerce;\r\n    return coerce ? coerce(owner, value) : value;\r\n  }\r\n\r\n  /**\r\n   * Compare the old value and new value for equality.\r\n   */\r\n  private _compareValue(oldValue: U, newValue: U): boolean {\r\n    let compare = this._compare;\r\n    return compare ? compare(oldValue, newValue) : oldValue === newValue;\r\n  }\r\n\r\n  /**\r\n   * Run the change notification if the given values are different.\r\n   */\r\n  private _maybeNotify(owner: T, oldValue: U, newValue: U): void {\r\n    let changed = this._changed;\r\n    if (changed && !this._compareValue(oldValue, newValue)) {\r\n      changed(owner, oldValue, newValue);\r\n    }\r\n  }\r\n\r\n  private _pid = Private.nextPID();\r\n  private _create: ((owner: T) => U);\r\n  private _coerce: ((owner: T, value: U) => U) | null;\r\n  private _compare: ((oldValue: U, newValue: U) => boolean) | null;\r\n  private _changed: ((owner: T, oldValue: U, newValue: U) => void) | null;\r\n}\r\n\r\n\r\n/**\r\n * The namespace for the `AttachedProperty` class statics.\r\n */\r\nexport\r\nnamespace AttachedProperty {\r\n  /**\r\n   * The options object used to initialize an attached property.\r\n   */\r\n  export\r\n  interface IOptions<T, U> {\r\n    /**\r\n     * The human readable name for the property.\r\n     *\r\n     * #### Notes\r\n     * By convention, this should be the same as the name used to define\r\n     * the public accessor for the property value.\r\n     *\r\n     * This **does not** have an effect on the property lookup behavior.\r\n     * Multiple properties may share the same name without conflict.\r\n     */\r\n    name: string;\r\n\r\n    /**\r\n     * A factory function used to create the default property value.\r\n     *\r\n     * #### Notes\r\n     * This will be called whenever the property value is required,\r\n     * but has not yet been set for a given owner.\r\n     */\r\n    create: (owner: T) => U;\r\n\r\n    /**\r\n     * A function used to coerce a supplied value into the final value.\r\n     *\r\n     * #### Notes\r\n     * This will be called whenever the property value is changed, or\r\n     * when the property is explicitly coerced. The return value will\r\n     * be used as the final value of the property.\r\n     *\r\n     * This will **not** be called for the initial default value.\r\n     */\r\n    coerce?: (owner: T, value: U) => U;\r\n\r\n    /**\r\n     * A function used to compare two values for equality.\r\n     *\r\n     * #### Notes\r\n     * This is called to determine if the property value has changed.\r\n     * It should return `true` if the given values are equivalent, or\r\n     * `false` if they are different.\r\n     *\r\n     * If this is not provided, it defaults to the `===` operator.\r\n     */\r\n    compare?: (oldValue: U, newValue: U) => boolean;\r\n\r\n    /**\r\n     * A function called when the property value has changed.\r\n     *\r\n     * #### Notes\r\n     * This will be invoked when the property value is changed and the\r\n     * comparator indicates that the old value is not equal to the new\r\n     * value.\r\n     *\r\n     * This will **not** be called for the initial default value.\r\n     */\r\n    changed?: (owner: T, oldValue: U, newValue: U) => void;\r\n  }\r\n\r\n  /**\r\n   * Clear the stored property data for the given owner.\r\n   *\r\n   * @param owner - The property owner of interest.\r\n   *\r\n   * #### Notes\r\n   * This will clear all property values for the owner, but it will\r\n   * **not** run the change notification for any of the properties.\r\n   */\r\n  export\r\n  function clearData(owner: any): void {\r\n    Private.ownerData.delete(owner);\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * The namespace for the module implementation details.\r\n */\r\nnamespace Private {\r\n  /**\r\n   * A typedef for a mapping of property id to property value.\r\n   */\r\n  export\r\n  type PropertyMap = { [key: string]: any };\r\n\r\n  /**\r\n   * A weak mapping of property owner to property map.\r\n   */\r\n  export\r\n  const ownerData = new WeakMap<any, PropertyMap>();\r\n\r\n  /**\r\n   * A function which computes successive unique property ids.\r\n   */\r\n  export\r\n  const nextPID = (() => {\r\n    let id = 0;\r\n    return () => {\r\n      let rand = Math.random();\r\n      let stem = `${rand}`.slice(2);\r\n      return `pid-${stem}-${id++}`;\r\n    };\r\n  })();\r\n\r\n  /**\r\n   * Lookup the data map for the property owner.\r\n   *\r\n   * This will create the map if one does not already exist.\r\n   */\r\n  export\r\n  function ensureMap(owner: any): PropertyMap {\r\n    let map = ownerData.get(owner);\r\n    if (map) {\r\n      return map;\r\n    }\r\n    map = Object.create(null) as PropertyMap;\r\n    ownerData.set(owner, map);\r\n    return map;\r\n  }\r\n}\r\n"],"names":["AttachedProperty"],"mappings":"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"}